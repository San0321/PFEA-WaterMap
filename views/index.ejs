<!DOCTYPE html>
<html>

  <head>
    <title>PFEA Water Quality Map</title>
    <link href="https://fonts.googleapis.com/css?family=Cabin:400,600" rel="stylesheet">
    <link rel="icon" type="image/png" href="img/favicon.png" />
    <link href="css/watermap.css" rel="stylesheet">
  </head>

  <body>
    <!-- Logo -->
    <a href="http://pfea.org" target="_blank"><img src="assets/logo.png" width="140" style="position: absolute; top: 10px; left: 10px; z-index: 2"></a>

    <!-- Info Button / Legend -->
    <img src="img/info-button.svg" width="30" class="my_popup_open" style="position: absolute; bottom: 10px; left: 10px; z-index: 2; cursor: pointer;">

    <!-- Legend Content-->
    <div id="my_popup">
      <p class="my_popup_close">&times;</p>
      <h1 class="legend">Legend</h1>
      <p>
        <ul class="legend">
          <li id="green"><b>Clean</b><br>0 - 400 cfu/ml</li>
          <li id="yellow"><b>Fair</b><br>500 - 600 cfu/ml</li>
          <li id="orange"><b>Somewhat Polluted</b><br>700 - 900 cfu/ml</li>
          <li id="red"><b>Polluted</b><br>1000+ cfu/ml</li>
        </ul></p>
    </div>

    <!-- Map -->
    <div id="map" style="z-index: 1"></div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu7Hwq7jgsjGyFqDUPaOOtiogq1tJJsAo">
    </script>
<script type="text/javascript">
  var sites = {
      "SAN ANTONIO": {
          name: "San Antonio del Mar",
          pos: {
              lat: 32.433887,
              lng: -117.099547
          },
      },
      "EL VIGIA": {
          name: "El Vigia",
          pos: {
              lat: 32.423887,
              lng: -117.099547
          },
      },
      "PARQUE MEXICO": {
          name: "Parque Mexico",
          pos: {
              lat: 32.434887,
              lng: -117.099547
          },
      },
      "EL FARO": {
          name: "El Faro",
          pos: {
              lat: 32.435887,
              lng: -117.199547
          },
      },
      "CAÑADA AZTECA": {
          name: "Cañada Azteca",
          pos: {
              lat: 32.433587,
              lng: -117.019547
          },
      }
  };

  function initMap(waterdata) {
      // console.log(JSON.stringify(waterdata));
      var markers = [];
      for (var i = 0; i < waterdata.length; i++) {
          var point = {};
          var site = sites[waterdata[i].sitio];

          point['name'] = site.name;
          point['pos'] = site.pos;
          var date = new Date();
          date.setTime((waterdata[i].date-(25567 + 1))*86400*1000);
          waterdata[i].date = (date.getMonth()+1) + '/' + date.getDate() + '/' + date.getFullYear() + ' ';

          point['date'] = waterdata[i].date + waterdata[i].time + " PST";
          point['cfuVal'] = waterdata[i]['ec[µs/cm]'];
          if (point['cfuVal'] <= 400) {
              point['cfuLabel'] = "Clean";
              point['icon'] = "img/green-pin.svg";
          }
          if (point['cfuVal'] < 600 && point['cfuVal'] > 400) {
              point['cfuLabel'] = "Fair";
              point['icon'] = "img/yellow-pin.svg";
          }
          if (point['cfuVal'] < 900 && point['cfuVal'] >= 600) {
              point['cfuLabel'] = "Somewhat Polluted";
              point['icon'] = "img/orange-pin.svg";
          }
          if (point['cfuVal'] >= 900) {
              point['cfuLabel'] = "Polluted";
              point['icon'] = "img/red-pin.svg";
          }
          markers.push(point);
      }
      var mapOptions = {
          zoom: 12,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          disableDefaultUI: true
      };
      var tijuana = {
          lat: 32.441964,
          lng: -117.089977
      };
      var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: tijuana,
          mapTypeControl: false,
          scrollwheel: false,
          fullscreenControl: false
      });
      for (var marker in markers) {
          marker = markers[marker];
          console.log(marker.name);
          var html = '<div id="content">' +
              '<h1>' + marker.name + '</h1>' +
              '<div id="bodyContent">' +
              '<h3>' + marker.cfuLabel + '</h3>' +
              '<p>' + marker.cfuVal + '</p>' +
              '<p class="date">' + 'Last updated: ' + marker.date + '</p>' +
              '</div>' +
              '</div>';
          var infoWindow = new google.maps.InfoWindow();

          var _marker = new google.maps.Marker({
              position: marker.pos,
              map: map,
              title: marker.name,
              html: html,
              icon: marker.icon,
          });
          _marker.addListener('click', function() {
              infoWindow.setContent(this.html);
              infoWindow.open(map, this);
          });
          _marker.addListener('mouseover', function() {
              infoWindow.setContent(this.html);
              infoWindow.open(map, this);

          });
          _marker.addListener('mouseout', function() {
              infoWindow.close();
          });
      };
      var currCenter = map.getCenter();
      google.maps.event.addDomListener(window, 'resize', function() {
          map.setCenter(currCenter);
      });
  }

  initMap(<%-JSON.stringify(waterdata)%>);
</script>
    
    <script src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="https://cdn.rawgit.com/vast-engineering/jquery-popup-overlay/1.7.13/jquery.popupoverlay.js"></script>

    <script>
      $(document).ready(function() {
        $('#my_popup').popup({
          transition: 'all 0.3s'
        });
      });
    </script>

  </body>
</html>
